name: MLflow CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: "0 0 * * 0"   # weekly
  workflow_dispatch:

jobs:

  train-model:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn mlflow boto3

    - name: Generate banknote dataset (dummy if missing)
      run: |
        python - <<EOF
        import pandas as pd
        import numpy as np
        
        np.random.seed(42)
        df = pd.DataFrame({
            'variance': np.random.randn(100),
            'skewness': np.random.randn(100),
            'curtosis': np.random.randn(100),
            'entropy': np.random.randn(100),
            'class': np.random.randint(0, 2, 100)
        })
        
        df.to_csv("MLProject/banknote_preprocessed.csv", index=False)
        print("Dataset banknote_preprocessed.csv created successfully")
        EOF

    - name: Run modelling.py
      run: |
        cd MLProject
        python modelling.py

    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: training-results
        path: |
          MLProject/mlruns/
          MLProject/*.csv
        retention-days: 30
        if-no-files-found: ignore


  build-docker:
    needs: train-model
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: training-results
        path: MLProject/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build & Push App Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          dapadeveloper/banknote_authentication:latest
          dapadeveloper/banknote_authentication:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build MLflow Model Docker Image
      run: |
        cd MLProject

        echo "Checking MLflow runs..."
        if [ -d "mlruns/0" ]; then
          LATEST_RUN=$(ls -t mlruns/0 | head -1)
          echo "Latest MLflow run: $LATEST_RUN"

          MODEL_DIR=""
          if [ -d "mlruns/0/$LATEST_RUN/artifacts/model" ]; then
            MODEL_DIR="mlruns/0/$LATEST_RUN/artifacts/model"
          elif [ -d "mlruns/0/$LATEST_RUN/artifacts/random_forest_model" ]; then
            MODEL_DIR="mlruns/0/$LATEST_RUN/artifacts/random_forest_model"
          fi

          if [ ! -z "$MODEL_DIR" ]; then
            echo "Found MLflow model: $MODEL_DIR"
            mlflow models build-docker \
              -m "$MODEL_DIR" \
              -n dapadeveloper/banknote_authentication_mlflow || true
          else
            echo "No MLflow model artifacts found."
          fi
        else
          echo "No MLflow experiment runs found."
        fi
