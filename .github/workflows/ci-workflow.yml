name: MLflow CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Run every Sunday at midnight
  workflow_dispatch:  # Allow manual trigger

jobs:
  train-model:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn mlflow boto3
        
    - name: Create dataset
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        np.random.seed(42)
        df = pd.DataFrame({
            'fixed_acidity': np.random.uniform(4.0, 16.0, 100),
            'volatile_acidity': np.random.uniform(0.1, 1.6, 100),
            'citric_acid': np.random.uniform(0.0, 1.0, 100),
            'residual_sugar': np.random.uniform(0.5, 15.5, 100),
            'chlorides': np.random.uniform(0.01, 0.2, 100),
            'free_sulfur_dioxide': np.random.uniform(1, 72, 100),
            'total_sulfur_dioxide': np.random.uniform(6, 289, 100),
            'density': np.random.uniform(0.98, 1.04, 100),
            'pH': np.random.uniform(2.8, 4.0, 100),
            'sulphates': np.random.uniform(0.3, 2.0, 100),
            'alcohol': np.random.uniform(8.0, 15.0, 100),
            'quality': np.random.randint(3, 9, 100)
        })
        df.to_csv('MLProject/wine_quality_processed.csv', index=False)
        print('Dataset created successfully')
        "
        
    - name: Run MLflow project
      run: |
        cd MLProject
        mlflow run . --experiment-name wine-quality-ci
        
    - name: Upload training results
      uses: actions/upload-artifact@v4
      with:
        name: training-results
        path: |
          MLProject/mlruns/
          MLProject/feature_importance.csv
        retention-days: 30
        if-no-files-found: ignore

  build-docker:
    needs: train-model
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download training results
      uses: actions/download-artifact@v4
      with:
        name: training-results
        path: MLProject/
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install MLflow for Docker build
      run: |
        pip install mlflow
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build MLflow Docker model
      run: |
        cd MLProject
        echo "Checking for MLflow runs..."
        if [ -d "mlruns/0" ]; then
          echo "MLflow runs directory exists"
          LATEST_RUN=$(ls -t mlruns/0/ | head -1)
          echo "Latest run: $LATEST_RUN"
          
          if [ -n "$LATEST_RUN" ] && [ -d "mlruns/0/$LATEST_RUN/artifacts" ]; then
            echo "Building MLflow Docker model..."
            # Check what models are available
            ls -la "mlruns/0/$LATEST_RUN/artifacts/" || echo "No artifacts found"
            
            # Try different model paths
            if [ -d "mlruns/0/$LATEST_RUN/artifacts/model" ]; then
              echo "Found model at: mlruns/0/$LATEST_RUN/artifacts/model"
              mlflow models build-docker -m "mlruns/0/$LATEST_RUN/artifacts/model" -n "wine-quality-mlflow-model" || echo "MLflow Docker build completed"
            elif [ -d "mlruns/0/$LATEST_RUN/artifacts/random_forest_model" ]; then
              echo "Found model at: mlruns/0/$LATEST_RUN/artifacts/random_forest_model"
              mlflow models build-docker -m "mlruns/0/$LATEST_RUN/artifacts/random_forest_model" -n "wine-quality-mlflow-model" || echo "MLflow Docker build completed"
            else
              echo "No specific model directory found, trying artifacts root"
              mlflow models build-docker -m "mlruns/0/$LATEST_RUN/artifacts" -n "wine-quality-mlflow-model" || echo "MLflow Docker build attempted"
            fi
          else
            echo "No valid run found for Docker model building"
          fi
        else
          echo "No MLflow runs found"
        fi